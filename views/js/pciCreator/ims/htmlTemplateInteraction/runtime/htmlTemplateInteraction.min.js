define("taoQtiItem/portableLib/OAT/util/EventMgr",[],function(){"use strict";return function(){const events={};this.get=event=>event&&events[event]?[...events[event]]:[],this.on=(event,callback)=>{let name;const tokens=event.split(".");tokens[0]&&(name=tokens.shift(),events[name]=events[name]||[],events[name].push({ns:tokens,callback:callback}))},this.off=event=>{event&&events[event]&&(events[event]=[])},this.trigger=(event,data)=>{events[event]&&events[event].forEach(e=>{e.callback.apply({type:event,ns:[]},data)})}}}),define("taoQtiItem/portableLib/OAT/util/event",["taoQtiItem/portableLib/OAT/util/EventMgr"],function(EventMgr){return{addEventMgr:function(instance){const eventMgr=new EventMgr;instance.on=(event,callback)=>{eventMgr.on(event,callback)},instance.off=event=>{eventMgr.off(event)},instance.trigger=(event,data)=>{eventMgr.trigger(event,data)}}}}),define("htmlTemplateInteraction/runtime/recordResponse",[],function(){"use strict";return{createRecord:function(){let entries=0<arguments.length&&arguments[0]!==void 0?arguments[0]:[];const names=entries.map(entry=>entry.name);if(names.length>new Set(names).size)throw new Error("Cannot createRecord with duplicate names");return{record:[...entries]}},createRecordEntry:function(name,baseType){let value=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;if(!name)throw new Error(`Cannot createRecordEntry with name: ${name}`);return null===value?{name,base:null}:{name,base:{[baseType]:value}}},getRecordEntryValue:function(){let entries=0<arguments.length&&arguments[0]!==void 0?arguments[0]:[],name=1<arguments.length&&arguments[1]!==void 0?arguments[1]:"";const match=entries.find(entry=>entry.name===name);return match?match.base&&Object.values(match.base)[0]:null}}}),define("text!htmlTemplateInteraction/runtime/tpl/markupInner.tpl",[],function(){return"<div class=\"iframe-wrapper\" style=\"position:relative\">\n    <iframe title=\"interaction\" sandbox=\"allow-same-origin\" style=\"width:100%;border:none;\"></iframe>\n</div>"}),define("htmlTemplateInteraction/runtime/htmlTemplateInteraction",["qtiCustomInteractionContext","taoQtiItem/portableLib/OAT/util/event","htmlTemplateInteraction/runtime/recordResponse","text!htmlTemplateInteraction/runtime/tpl/markupInner.tpl"],function(qtiCustomInteractionContext,event,record,markupInnerHtml){"use strict";function createBlobURL(code){let type=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"text/html";const blobUrl=URL.createObjectURL(new Blob([code],{type}));return blobUrls.add(blobUrl),blobUrl}function revokeBlobUrls(){for(const url of blobUrls.values())URL.revokeObjectURL(url);blobUrls=new Set}function getCounts(){let text=0<arguments.length&&arguments[0]!==void 0?arguments[0]:"";const wordMatches="string"==typeof text&&text.match(/[^\s.,:;?!&#%/*+=]+/g)||[];return{words:wordMatches.length,chars:text.length}}function getElementInfo(element){if(!element)return{};const typeAttr=element.getAttribute("type"),isTextArea="TEXTAREA"===element.tagName,isSelect="SELECT"===element.tagName,isSelectMultiple=isSelect&&element.getAttribute("multiple"),isTextInput="INPUT"===element.tagName&&(["text","number","email","url","search"].includes(typeAttr)||!typeAttr),isCheckboxInput="INPUT"===element.tagName&&"checkbox"===typeAttr,isRadioInput="INPUT"===element.tagName&&"radio"===typeAttr;return{isTextArea,isSelect,isTextInput,isCheckboxInput,isRadioInput,isUnsupportedElement:!isTextArea&&(!isSelect||isSelectMultiple)&&!isTextInput&&!isCheckboxInput&&!isRadioInput}}function htmlTemplateInteractionFactory(){return{typeIdentifier:_typeIdentifier,getResponse:function(){const recordEntries=[],usedGroupNames=[];return this.getResponseElts().forEach(element=>{const{isTextArea,isSelect,isTextInput,isCheckboxInput,isRadioInput}=getElementInfo(element);if(isTextArea||isTextInput)recordEntries.push(record.createRecordEntry(element.name,"string",element.value&&element.value.substring(0,maxlength)||null));else if(isSelect)recordEntries.push(record.createRecordEntry(element.name,"identifier",element.value||null));else if(isCheckboxInput)recordEntries.push(record.createRecordEntry(element.name,"boolean",element.checked));else if(isRadioInput&&!usedGroupNames.includes(element.name)){const radioGroupCheckedElt=this.iframe.contentDocument.querySelector(`input[type=radio][name=${element.name}][data-response]:checked`),value=radioGroupCheckedElt?radioGroupCheckedElt.value:null;recordEntries.push(record.createRecordEntry(element.name,"identifier",value)),usedGroupNames.push(element.name)}}),recordEntries.length&&(this.responseRecordValue=recordEntries),record.createRecord(this.responseRecordValue)},destroy:function(){this.dom.innerHTML="",revokeBlobUrls()},getTypeIdentifier:function(){return _typeIdentifier},initialize:function(responseIdentifier,dom,properties){this.responseIdentifier=responseIdentifier,this.dom=dom,this.properties=properties||{};const wrapper=document.createElement("div");dom.querySelector(".htmlTemplateInteraction").append(wrapper),wrapper.outerHTML=markupInnerHtml,this.iframe=dom.querySelector("iframe"),this.iframe.dataset.responseIdentifier=responseIdentifier,dom.dispatchEvent(new CustomEvent("init",{bubbles:!0,detail:{iframe:this.iframe}})),this.render()},render:function(){const iframeOnload=()=>this.postRender();this.iframe.removeEventListener("load",iframeOnload),this.iframe.addEventListener("load",iframeOnload),revokeBlobUrls();try{this.iframe.src=createBlobURL(this.properties.html)}catch(e){console.error(e),this.iframe.src=createBlobURL("Invalid or missing <code>html</code> property")}},postRender:function(){this.iframe.height=this.iframe.contentWindow.document.body.scrollHeight||500,this.getResponseElts().forEach(element=>{const{isTextArea,isSelect,isTextInput,isCheckboxInput,isRadioInput,isUnsupportedElement}=getElementInfo(element);isUnsupportedElement?console.warn("Unsupported data-response element in template:",element.outerHTML):element.name?isTextArea||isTextInput?(element.setAttribute("maxlength",element.getAttribute("maxlength")||maxlength),this.properties.isReviewMode&&element.setAttribute("readonly","true")):(isSelect||isCheckboxInput||isRadioInput)&&this.properties.isReviewMode&&element.setAttribute("disabled","true"):console.warn("Response element found without name attribute and won't be considered:",element.outerHTML)}),this.renderResponseValues(),this.connectWordcounts()},getResponseElts:function(){if(!this.iframe.contentDocument)return[];const elts=[...this.iframe.contentDocument.querySelectorAll("[data-response][name]")];return elts.filter(elt=>!getElementInfo(elt).isUnsupportedElement)},renderResponseValues:function(){this.responseRecordValue&&this.getResponseElts().forEach(element=>{const{isTextArea,isTextInput,isSelect,isCheckboxInput,isRadioInput}=getElementInfo(element),elementResponseValue=record.getRecordEntryValue(this.responseRecordValue,element.name);if(isTextArea||isTextInput)element.value=elementResponseValue||"";else if(isSelect){const options=element.querySelectorAll("option");options.forEach(optionElt=>{optionElt.selected=optionElt.value===elementResponseValue})}else isCheckboxInput?element.checked=!!elementResponseValue:isRadioInput&&(element.checked=elementResponseValue===element.getAttribute("value"))})},connectWordcounts:function(){const wordcountTargets=this.iframe.contentDocument.querySelectorAll("[data-wordcount-for]")||[];wordcountTargets.forEach(wcTarget=>{const wcSource=this.iframe.contentDocument.querySelector(`[name=${wcTarget.dataset.wordcountFor}]`),{isTextArea,isTextInput}=getElementInfo(wcSource);if(isTextArea||isTextInput){const{words}=getCounts(wcSource.value);wcTarget.textContent=`${words} word(s)`,wcSource.addEventListener("input",e=>{const{words}=getCounts(e.target.value);wcTarget.textContent=`${words} word(s)`})}})},setResponse:function(response){response&&response.record&&(this.responseRecordValue=response.record||[],this.renderResponseValues())},resetResponse:function(){this.setResponse({record:[]})},setSerializedState:function(state){state&&state.response&&this.setResponse(state.response)},getSerializedState:function(){return{response:this.getResponse()}}}}console.log("in src runtime");const _typeIdentifier="htmlTemplateInteraction",maxlength=1e4;let blobUrls=new Set;qtiCustomInteractionContext.register({typeIdentifier:"htmlTemplateInteraction",getInstance(dom,config,state){const interaction=htmlTemplateInteractionFactory(),pciInstance={getResponse(){return interaction.getResponse()},getState(){return interaction.getSerializedState()},oncompleted(){interaction.destroy()}},responseIdentifier=Object.keys(config.boundTo)[0],response=config.boundTo[responseIdentifier]||{record:[]};interaction.initialize(responseIdentifier,dom,config.properties),interaction.setResponse(response),interaction.setSerializedState(state),event.addEventMgr(pciInstance),pciInstance.on("configChange",newProperties=>{Object.assign(interaction.properties,newProperties),interaction.render()}),"function"==typeof config.onready&&config.onready(pciInstance,state),interaction.pciInstance=pciInstance}})}),define(["htmlTemplateInteraction/runtime/htmlTemplateInteraction"],function(IMSPCI){return IMSPCI});